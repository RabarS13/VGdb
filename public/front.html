<!DOCTYPE html>
<html>
<head>
  <title>GameVerse</title>
</head>
<body>
  <div style="display: flex; justify-content: space-between;">
    <h1>ðŸŽ® Welcome to GameVerse</h1>
    <div id="authArea"></div>
  </div>

  <hr>

  <h2>Search for Games</h2>
  <input type="text" id="searchBox" placeholder="Enter game name..." />
  <button onclick="searchGame()">Search</button>
  <div id="results"></div>

  <script>
    // Show login/logout based on token
    const authDiv = document.getElementById('authArea');
    if (localStorage.getItem('token')) {
      authDiv.innerHTML = '<button onclick="logout()">Logout</button>';
    } else {
      authDiv.innerHTML = '<a href="/login.html">Login</a> | <a href="/register.html">Register</a>';
    }

    function logout() {
      localStorage.removeItem('token');
      location.reload();
    }

    // RAWG API search function
    async function searchGame() {
      const query = document.getElementById('searchBox').value;
      const response = await fetch(`https://api.rawg.io/api/games?key=ba9c4ee9c6c64edba467c77bbc0afe3b&search=${encodeURIComponent(query)}`);
      const data = await response.json();
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';

      data.results.forEach(game => {
        const div = document.createElement('div');
        div.innerHTML = `
          <h3>${game.name}</h3>
          <img src="${game.background_image}" width="200" />
          <p>Released: ${game.released}</p>
          <a href="https://rawg.io/games/${game.slug}" target="_blank">
            <button>View on RAWG</button>
          </a>
          <button onclick='addToFavorites(${JSON.stringify(game)})'>Add to Favorites</button>
          <hr/>
        `;
        resultsDiv.appendChild(div);
      });
    }

    // Add to user's favorite games
    async function addToFavorites(game) {
      const token = localStorage.getItem('token');
      if (!token) {
        alert("Please log in first!");
        return;
      }

      const payload = {
        gameId: game.id,
        title: game.name,
        cover: game.background_image,
        releaseDate: game.released,
        genre: game.genres.map(g => g.name)
      };

      const res = await fetch('/api/games/favorite', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + token
        },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      alert(result.message || result.error);
    }
  </script>
</body>
</html>
